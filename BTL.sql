CREATE DATABASE CSDL_BTL
GO
USE CSDL_BTL
--------TẠO BẢNG
-----BẢNG PHÒNG
CREATE TABLE PHONG(
                   MAPHONG NVARCHAR(10) NOT NULL PRIMARY KEY,
				   DIENTICH INT,
				   DONGIA INT,
				   LOAIPHONG NCHAR(50),
				   SOGIUONG INT,
				   TINHTRANG NCHAR(50) ,				   
				   )

------BẢNG ĐOÀN
CREATE TABLE DOAN(
                  MADOAN NCHAR(10) NOT NULL PRIMARY KEY,
				  TENDOAN NCHAR(50),
				  SOCMT NCHAR(50)  ,
				  SDT_TD INT,

                  )	

----BẢNG  KHÁCH HÀNG
CREATE TABLE KHACHHANG(
                       SOCMT NCHAR(50) NOT NULL PRIMARY KEY,
					   TEN NCHAR(10),
					   DIACHI NCHAR(50),
					   LOAIKHACH NCHAR(10) CHECK (LOAIKHACH IN ('VIP','THUONG')),
					   GIOITINH NCHAR(10) CHECK (GIOITINH IN('NAM','NU')),
					   SDT INT,
					   MADOAN NCHAR(10) REFERENCES DOAN
					   )				  				  

-----BẢNG NHÂN VIÊN
CREATE TABLE NHANVIEN(
                      MANV NCHAR(10) NOT NULL PRIMARY KEY,
					  TENNV NCHAR(50) NOT NULL,
					  GIOITINH NCHAR(10) CHECK (GIOITINH IN('NAM','NU')),
					  CHUCVU NCHAR(50)
					  )
					  
------BẢNG DỊCH VỤ
CREATE TABLE DICHVU(
                    MADICHVU NCHAR(10) PRIMARY KEY,
					TENDICHVU NCHAR(50),
					GIADV INT,
					DONVITINH NVARCHAR(10)
					)
					
----------TẠO BẢNG ĐẶT PHÒNG
CREATE TABLE DATPHONG(
                        SOCMT NCHAR(50) NOT NULL REFERENCES KHACHHANG,
						TGDEN DATE,
						TGDKDI DATE,
						MAPHONG NVARCHAR(10) NOT NULL REFERENCES PHONG,
						PRIMARY KEY(SOCMT,TGDEN)
						)
---------TẠO BẢNG TRẢ PHÒNG
CREATE TABLE TRAPHONG(
                        SOCMT NCHAR(50) NOT NULL REFERENCES KHACHHANG,
						TGDI DATE NOT NULL,
						MAPHONG NVARCHAR(10) NOT NULL REFERENCES PHONG,
						PRIMARY KEY(SOCMT,TGDI)
						)
						
--------TẠO BẢNG HÓA ĐƠN
CREATE TABLE HOADONTP(
                    MAHDTP NCHAR(50) NOT NULL,
					NGAYTHANG DATE,
					MaDV NCHAR(10) REFERENCES DICHVU ,
					SOLUONG INT,
					MANV NCHAR(10) NOT NULL REFERENCES NHANVIEN,
					SOCMT NCHAR(50) NOT NULL REFERENCES KHACHHANG,
					THANHTIEN INT,
					PRIMARY KEY(MAHDTP),
					)
------------ TẠO BẢNG HÓA ĐƠN TỔNG
CREATE TABLE HOADON(
                    MAHD NCHAR(10) NOT NULL,
					NGAYDEN DATE,
					NGAYTHANGHD DATE,
					MANV NCHAR(10) NOT NULL REFERENCES NHANVIEN,
					SOCMT NCHAR(50) NOT NULL REFERENCES KHACHHANG ,
					MAPHONG NVARCHAR(10) NOT NULL REFERENCES PHONG,
					TONGTIEN INT,
					PRIMARY KEY(MAHD),
                 )
-------NHẬP DỮ LIỆU VÀO BẢNG
----BẢNG PHÒNG
INSERT INTO PHONG VALUES('PT101',15,250000,N'THƯỜNG',1,NULL),
                         ('PT102',15,250000,N'THƯỜNG',2,NULL),
						 ('PT103',15,300000,N'VIP',1,NULL),
						 ('PT104',15,350000,N'THƯỜNG',2,NULL),
						 ('PT201',20,350000,N'THƯỜNG',1,NULL),
						 ('PT202',20,350000,N'THƯỜNG',2,NULL),
						 ('PT203',20,400000,N'VIP',1,NULL),
                          ('PT204',20,450000,N'VIP',2,NULL),
						  ('PT301',15,250000,N'THƯỜNG',1,NULL),
						  ('PT302',15,250000,N'THƯỜNG',2,NULL),
						  ('PT303',20,300000,N'THƯỜNG',1,NULL),
						  ('PT304',20,300000,N'THƯỜNG',2,NULL),
						  ('PT401',15,300000,N'VIP',1,NULL),
						  ('PT402',15,300000,N'VIP',2,NULL),
						  ('PT403',20,400000,N'VIP',1,NULL),
						  ('PT404',20,450000,N'VIP',2,NULL) 
-----DELETE FROM KHACHHANG
------bảng ĐOÀN
INSERT INTO DOAN VALUES('D001',N'CT HÒA PHÁT','123456789',0978123456),
                        ('D002',N'XÓM CHÙA','192837465',123456789),
						('D003',N'PHƯỢT ĐÊM','17150033',0192837465)
INSERT INTO DOAN VALUES('D004',N'HƯƠNG ĐÊM','12993846',092341356)
						


-------BẢNG KHÁCH HÀNG
INSERT INTO KHACHHANG VALUES ('123456789',N'DƯƠNG',N'HÀ NỘI','VIP','NAM',0978123456, 'D001'),
                             ('987654321',N'HOA',N'HÀ NỘI','VIP','NU',071234586, 'D001'),
							 ('192837465',N'HUYỀN',N'THÁI BÌNH','THUONG','NU',123456789, 'D002'),
							 ('546738219',N'LONG',N'THÁI BÌNH','THUONG','NAM',089764123, NULL),
							  ('17150033',N'ĐẠT',N'NAM ĐỊNH','THUONG','NAM',0978123456, 'D001'),
							  ('21347569',N'PHONG',N'QUẢNG NINH','THUONG','NAM',0192837465, 'D003'),
							  ('12993846',N'TÀI',N'THANH HÓA','VIP','NAM',092341356, 'D004'),
							  ('123456798',N'PHƯƠNG',N'BẮC NINH','VIP','NAM',012345678, NULL),
							  ('345678902',N'LINH',N'PHÚ THỌ','VIP','NU',0129345678, 'D002'),
							  ('123456788',N'HOÀNG',N'HÀ NỘI','VIP','NAM',0978123455, 'D002'),
							  ('123456780',N'DƯƠNG',N'HÀ NỘI','VIP','NAM',0978121456, 'D002'),
							  ('213475693',N'MINH',N'QUẢNG NINH','THUONG','NAM',0912837465, 'D003'),
							  ('129938463',N'TÀI',N'HÀ NỘI','VIP','NAM',092331356, 'D004'),
							  ('123356275',N'ANH',N'NAM ĐỊNH','THUONG','NAM',097812379, NULL),
							  ('123456799',N'PHƯƠNG ANH',N'BẮC NINH','THUONG','NU',012345679, NULL),
							  ('123456777',N'PHƯƠNG',N'HÀ NAM','THUONG','NAM',012345777, NULL),
							  ('123444746',N'LONG',N'BẮC NINH','VIP','NAM',012345555, NULL),
							  ('018343981',N'PHƯƠNG',N'THANH HÓA','THUONG','NU',012332128, NULL)
-----BẢNG NHÂN VIÊN
INSERT INTO NHANVIEN VALUES ('NV001',N'LAN',N'NU',N'LỄ TÂN'),
                            ('NV002',N'HƯƠNG',N'NU',N'LỄ TÂN'),
							 ('NV003',N'HOA',N'NU',N'DỌN PHÒNG'),
                            ('NV004',N'ANH',N'NAM',N'DỌN PHÒNG'),
							('NV005',N'TRANG',N'NU',N'DỌN PHÒNG'),
							('NV006',N'LÝ',N'NU',N'DỌN PHÒNG'),
							('NV007',N'DUY',N'NAM',N'PHỤC VỤ'),
							('NV008',N'LINH',N'NU',N'PHỤC VỤ')


------BẢNG DỊCH VỤ
INSERT INTO DICHVU VALUES ('DV001',N'ĂN UỐNG',100000,N'SUẤT'),
                          ('DV002',N'DỌN PHÒNG',20000,N'LƯỢT'),
						  ('DV003',N'GIẶT ĐỒ',15000,N'2 BỘ'),
						  ('DV004',N'BỂ BƠI',50000,N'LƯỢT'),
						  ('DV005',N'XÔNG HƠI',70000,N'LƯỢT'),
						  ('DV006',N'BIA',15000,N'CHAI'),
						  ('DV007',N'NƯỚC NGỌT',12000,N'CHAI'),
                          ('DV008',N'HOA QUẢ',100000,N'ĐĨA')
-- NHẬP DỮ LIỆU BẢNG ĐẶT PHÒNG
INSERT INTO DATPHONG VALUES ('123456780', '2015/10/20', '2015/10/22', 'PT201')
INSERT INTO DATPHONG VALUES('123456788', '2015/10/20', '2015/10/22', 'PT202')
INSERT INTO DATPHONG VALUES('192837465', '2015/10/20', '2015/10/22', 'PT203')
INSERT INTO DATPHONG VALUES('345678902', '2015/10/20', '2015/10/22', 'PT204')
INSERT INTO DATPHONG VALUES('123456789', '2015/11/23', '2015/11/25', 'PT101')
INSERT INTO DATPHONG VALUES('17150033', '2015/11/23', '2015/11/25', 'PT102')
INSERT INTO DATPHONG VALUES('987654321', '2015/11/23', '2015/11/25', 'PT104')
INSERT INTO DATPHONG VALUES('21347569', '2015/11/23', '2015/11/25', 'PT202')
INSERT INTO DATPHONG VALUES('213475693', '2015/11/23', '2015/11/25', 'PT201')
INSERT INTO DATPHONG VALUES('018343981', '2015/11/23', '2015/11/24', 'PT203')
INSERT INTO DATPHONG VALUES('345678902', '2015/11/23', '2015/11/26', 'PT303')
INSERT INTO DATPHONG VALUES('546738219', '2015/11/25', '2015/11/26', 'PT203')
INSERT INTO DATPHONG VALUES('123356275', '2015/11/26', '2015/11/28', 'PT402')
INSERT INTO DATPHONG VALUES('123444746', '2015/11/26', '2015/11/29', 'PT102')
INSERT INTO DATPHONG VALUES('12993846', '2015/12/8', '2015/12/12', 'PT403')
INSERT INTO DATPHONG VALUES('123456799', '2015/12/8', '2015/12/10', 'PT402')
INSERT INTO DATPHONG VALUES('129938463', '2015/12/8', '2015/12/12', 'PT401')
INSERT INTO DATPHONG VALUES('123456780', '2015/12/10', '2015/12/12', 'PT201')
							
--- nhập dữ liệu bảng TRẢ PHÒNG:
INSERT INTO TRAPHONG VALUES ('123456780',  '2015/10/22', 'PT201'),
							('123456788', '2015/10/22', 'PT202'),
							('192837465', '2015/10/22', 'PT203'),
							('345678902', '2015/10/22', 'PT204'),
							('123456789', '2015/11/25', 'PT101'),
							('17150033',  '2015/11/25', 'PT102'),
							('987654321', '2015/11/25', 'PT104'),
							('21347569', '2015/11/25', 'PT202'),
							('213475693', '2015/11/25', 'PT201'),
							('018343981', '2015/11/24', 'PT203'),
							('345678902', '2015/11/25', 'PT303'),
							('546738219', '2015/11/26', 'PT203'),
							('123356275', '2015/11/28', 'PT402'),
							('123444746', '2015/11/27', 'PT102')

-- NHẬP DỮ LIỆU BẢNG HÓA ĐƠN TP:
INSERT INTO HOADONTP VALUES ('HDTP001','2015/10/20','DV001',2,'NV001','123456780',NULL),
							('HDTP002','2015/10/20','DV006',10,'NV001','192837465',NULL),
							('HDTP003','2015/10/20','DV007',2,'NV001','192837465',NULL),
							('HDTP004','2015/10/20','DV001',2,'NV002','192837465',NULL),
							('HDTP005','2015/10/20','DV003',2,'NV002','123456780',NULL),
							('HDTP006','2015/10/20','DV001',2,'NV002','123456788',NULL),
							('HDTP007','2015/10/21','DV005',1,'NV002','123456780',NULL),
							('HDTP008','2015/10/21','DV004',2,'NV001','123456788',NULL),
							('HDTP009','2015/10/22','DV008',1,'NV001','123456788',NULL),
							('HDTP010','2015/10/23','DV008',1,'NV002','17150033',NULL),
							('HDTP011','2015/10/23','DV007',1,'NV002','17150033',NULL),
							('HDTP012','2015/10/24','DV002',1,'NV003','018343981',NULL),
							('HDTP013','2015/10/24','DV002',1,'NV003','018343981',NULL)						

INSERT INTO HOADON VALUES  ('HD0001','2015-10-20','2015/10/22','NV001','123456780','PT201', NULL),
							('HD0002','2015-10-20','2015/10/22','NV001','123456788',   'PT202', NULL),
							('HD0003',  '2015-10-20','2015/10/22','NV001','192837465', 'PT203', NULL),
							('HD0004', '2015-10-20', '2015/10/22','NV002','345678902', 'PT204', NULL),
							('HD0005',  '2015-11-23','2015/11/24','NV001','123456789', 'PT101', NULL),
							('HD0006',  '2015-11-23','2015/11/24','NV002','17150033', 'PT102', NULL),
							('HD0007', '2015-11-23','2015/11/24','NV002', '987654321', 'PT104', NULL),
							('HD0008',  '2015-11-23','2015/11/25' ,'NV003','21347569', 'PT202', NULL),
							('HD0009',  '2015-11-23','2015/11/25','NV001', '213475693','PT201', NULL),
							('HD0010',  '2015-11-23','2015/11/24','NV003','345678902', 'PT203', NULL),
							('HD0011', '2015-11-23','2015/11/25','NV003', '345678902', 'PT303', NULL),
							('HD0012', '2015-11-25','2015/11/26','NV001','123356275',  'PT203', NULL)
							

SELECT * FROM DOAN							
SELECT * FROM KHACHHANG
SELECT * FROM PHONG
SELECT * FROM DATPHONG ORDER BY TGDEN
SELECT * FROM TRAPHONG ORDER BY TGDI
SELECT * FROM HOADON ORDER BY NGAYTHANGHD
SELECT * FROM HOADONTP
SELECT * FROM DICHVU
SELECT * FROM NHANVIEN

----
SELECT K.SOCMT,K.TEN,SUM(TP.THANHTIEN) tendv,SUM(HD.TONGTIEN) tienphong
FROM KHACHHANG K, HOADONTP TP, HOADON HD
WHERE K.SOCMT=TP.SOCMT AND K.SOCMT=HD.SOCMT
GROUP BY K.SOCMT,K.TEN


ALTER TABLE DOAN ADD SONG NCHAR(10)
alter table DOAN DROP COLUMN SONG 
---
create trigger THEM on KHACHHANG AFTER INSERT
AS
BEGIN
UPDATE DOAN SET SONG = (SELECT MADOAN,COUNT(MADOAN) FROM inserted) 
WHERE inserted.MADOAN=DOAN.MADOAN
END



----xem ngày 20/10/2015 có bao nhiêu phong đc thuê
select MAPHONG 
from DATPHONG
where TGDEN='2015-10-20'

----KHI MÃ PHÒNG TRONG ĐẶT PHÒNG THÌ PHÒNG ĐẤY ĐÃ CHO THUÊ
create trigger SUA on DATPHONG after insert 
as
begin
update PHONG set TINHTRANG = N'ĐÃ CHO THUÊ' where MAPHONG = (select MAPHONG FROM inserted)
END
--cách khác
create trigger SUA1 on DATPHONG after update 
as
begin
update PHONG set TINHTRANG = N'ĐÃ CHO THUÊ' where MAPHONG = (select MAPHONG FROM inserted)
END


create trigger SUA2 on DATPHONG after update
as
begin
update PHONG set TINHTRANG = N'CÒN TRỐNG' where MAPHONG not in (select MAPHONG FROM inserted)
END

SELECT * FROM PHONG

-----XÓA ĐOÀN VÀ KH THUỘC ĐOÀN SẼ NULL MADOAN
create trigger THU23 on DOAN INSTEAD OF delete
as
declare @MADOAN nvarchar(10)
select @MADOAN=MADOAN from deleted
begin
update KHACHHANG set MADOAN=null where MADOAN=@MADOAN
delete from DOAN where MADOAN=@MADOAN
end
delete from DOAN where MADOAN =N'D004'
DROP TRIGGER THU23

---DÙNG HÀM KTRA PHÒNG TRỐNG
CREATE FUNCTION CHECKNGAY (@NGAYCHEK DATE)
RETURNS TABLE
AS
RETURN
( 
select P.MAPHONG, DIENTICH, DONGIA,LOAIPHONG,SOGIUONG
FROM PHONG P
WHERE MAPHONG =@NGAYCHEK)
/*UNION
SELECT P.MAPHONG, DIENTICH, DONGIA,LOAIPHONG,SOGIUONG
FROM PHONG P, TRAPHONG TP
WHERE TP.TGDI < @NGAYCHEK AND P.MAPHONG=TP.MAPHONG
EXCEPT
select P.MAPHONG, DIENTICH, DONGIA,LOAIPHONG,SOGIUONG
FROM PHONG P, DATPHONG DP
where DP.TGDEN > @NGAYCHEK and P.MAPHONG=DP.MAPHONG*/

select * from CHECKNGAY
DROP FUNCTION CHECKNGAY
















---TÌM RA NGÀY THU ĐC NHIỀU TIỀN NHẤT(ít nhất - bỏ desc)
SELECT TOP 1 * FROM HOADON
order by TONGTIEN DESC
---tìm ra nhân viên lập từ 4 hóa đơn trở lên
create view bangtam as
( select manv,COUNT(manv) SoHD
from HOADON
group by manv
)
select manv,SoHD
from bangtam
where SoHD >= 4


--

---số tiên lớn nhất thu đc từng ngày ( ngày 25/11/2015)
select  ngaythanghd,sum(TONGTIEN) tt
FROM HOADON
---WHERE NGAYTHANGHD='2015-11-25'
group by NGAYTHANGHD

----in ra những hoa don trc ngày 18/11/2015
SELECT MAHD , NGAYTHANGHD
FROM HOADON
WHERE NGAYTHANGHD < '2015-11-18'
GROUP BY  NGAYTHANGHD,MAHD

-----xem số nv từng chức vụ
SELECT CHUCVU,COUNT(CHUCVU)
FROM NHANVIEN
GROUP BY CHUCVU

-- tính tổng tiền của hóa đơn tp:
DECLARE @Tong int, @dongia int, @soluong int, @ma nchar(50)
DECLARE cur_ThanhTien CURSOR
FORWARD_ONLY 
--DYNAMIC
FOR
SELECT MAHDTP
FROM HOADONTP

OPEN cur_ThanhTien

WHILE 0=0
BEGIN
FETCH NEXT FROM cur_ThanhTien
INTO @ma
IF @@FETCH_STATUS<>0
BREAK
ELSE
BEGIN
SELECT @soluong = SOLUONG FROM HOADONTP WHERE MAHDTP = @ma
SELECT @dongia = GIADV FROM DICHVU, HOADONTP WHERE MaDV = MADICHVU AND MAHDTP = @ma
SELECT @Tong = @soluong*@dongia
UPDATE HOADONTP
SET THANHTIEN = @Tong
WHERE CURRENT OF cur_ThanhTien
END
END
CLOSE cur_ThanhTien
DEALLOCATE cur_ThanhTien








--TÍNH TỔNG TIỀN CHO HÓA ĐƠN:
DECLARE @TTIEN int, @TGDEN DATE, @NGD INT, @TGDI DATE, @NGDI INT, @MAHD nchar(50), @NGAY INT, @GIA INT
DECLARE CUR_TONGTIEN CURSOR
FORWARD_ONLY 
DYNAMIC
FOR
SELECT MAHD
FROM HOADON

OPEN CUR_TONGTIEN

WHILE 0=0
BEGIN
FETCH NEXT FROM CUR_TONGTIEN
INTO @MAHD
IF @@FETCH_STATUS<>0
BREAK
ELSE
BEGIN
SELECT @TGDEN = TGDEN FROM DATPHONG, HOADON WHERE HOADON.SOCMT = DATPHONG.SOCMT 
												AND HOADON.MAPHONG = DATPHONG.MAPHONG 
												AND MAHD = @MAHD
												AND NGAYDEN = TGDEN
SELECT @TGDI = NGAYTHANGHD FROM TRAPHONG, HOADON WHERE HOADON.SOCMT = TRAPHONG.SOCMT 
												AND HOADON.MAPHONG = TRAPHONG.MAPHONG 
												AND MAHD = @MAHD
SELECT @NGD = DATEPART(DY, @TGDEN) 
SELECT @NGDI = DATEPART(DY, @TGDI) 
IF @NGD <@NGDI
SELECT @NGAY = @NGDI - @NGD
SELECT @GIA = DONGIA FROM PHONG, HOADON WHERE PHONG.MAPHONG = HOADON.MAPHONG AND MAHD = @MAHD
SELECT @TTIEN = @NGAY*@GIA

UPDATE HOADON
SET TONGTIEN = @TTIEN
WHERE CURRENT OF CUR_TONGTIEN
END
END
CLOSE CUR_TONGTIEN
DEALLOCATE CUR_TONGTIEN





-- THỦ TỤC TÍNH THÀNH TIỀN CỦA HÓA ĐƠN:
CREATE PROC TINHTIEN @TONG int
AS
BEGIN
DECLARE @SOLUONG INT, @DONGIA INT, @MA NCHAR(10)
SELECT @soluong = SOLUONG FROM HOADONTP WHERE MAHDTP = @ma
SELECT @dongia = GIADV FROM DICHVU, HOADONTP WHERE MaDV = MADICHVU AND MAHDTP = @ma
SELECT @Tong = @soluong*@dongia
UPDATE HOADONTP
END



-- BTVN
--1.THÊM TRƯỜNG TỔNG NHÂN VIÊN VÀO BẢNG PHÒNG BAN, TẠO TRIGGER ĐỂ KHI THÊM SỬA, XÓA THÌ TỰ ĐỘNG CẬP NHẬT LẠI TRƯỜNG TỔNG SỐ NV
--2. TẠO TRIGGER KHI XÓA NV SẼ TỰ ĐỘNG XÓA THÔNG TIN NV THAM GIA DỰ ÁN VÀ THÔNG TIN THÂN NHÂN NHÂN VIÊN
--


DECLARE CUR_CHECK CURSOR
FORWARD_ONLY 
--DYNAMIC
FOR
SELECT MAPHONG
FROM PHONG

OPEN CUR_CHECK

WHILE 0=0
BEGIN
DECLARE @NGAY DATE, @MAP NCHAR(10), @CHECK NVARCHAR(50)
SET @NGAY = '2015/11/22'
FETCH NEXT FROM CUR_CHECK
INTO @MAP
IF @@FETCH_STATUS<>0
BREAK
ELSE
BEGIN
SELECT @MAP = MAPHONG FROM PHONG
IF (@MAP IN (select P.MAPHONG FROM PHONG P
			WHERE MAPHONG NOT IN (SELECT MAPHONG FROM DATPHONG)
			UNION
			SELECT   P.MAPHONG  FROM PHONG P, TRAPHONG TP
			WHERE TP.TGDI < @NGAY AND @MAP =TP.MAPHONG
			EXCEPT
			 select  P.MAPHONG FROM PHONG P, DATPHONG DP
			where DP.TGDEN > @NGAY and @MAP=DP.MAPHONG)) 
SET @CHECK = N'CÒN TRỐNG'
ELSE SET @CHECK = N'ĐÃ CHO THUÊ'
UPDATE PHONG
SET TINHTRANG = @CHECK
WHERE CURRENT OF CUR_CHECK
END
END
CLOSE CUR_CHECK
DEALLOCATE CUR_CHECK